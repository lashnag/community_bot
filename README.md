## Комьюнити бот
### Описание
Бот используется для записи на мероприятия. Основная цель - сделать более справедливым распределение ограниченных мест.

Механика бота: до мероприятия присылается голосовалка, где отмечаются все желающие. Опционально присылается голосовалка с подтверждением тех кто
отметился. 

За заданное время перед мероприятием бот присылает итоговый список участников и список запасных с упоминанием на основе двух голосовалок. Логика формирования списка основного списка и
запасного: сначала берутся участники, которые не были на прошлом занятии. Остальные берутся рандомно в соответствии с вместимостью коммьюнити.

После публикации списка есть возможность выписаться из мероприятия через команду /replace в личке бота. Если был резервный список, то человек попадет в
основной список автоматически.

Так же админ комьюнити после формирования итогового списка может получить его еще раз через команду /participants_list для того чтобы легко было
понять кто пойдет если были замены.

Личка бота позволяет:
- Админу создать мероприятие (/create_appointment)
- Админу удалить мероприятие (/delete_event)
- Админу получить список мероприятий (/fetch_events, /fetch_short_events)
- Участнику выписаться из мероприятия (бот пришлет сообщение в группу и выберет из запасного списка следующего)

Публичные команды бота (может выполнять админ комьюнити):
- Вывести список участников (/participants_list)

### Настройка
- Заводим нового бота через botfather
- Настраиваем боту команды (список внизу)
- Ставим в настройках бота [Privacy mode](https://core.telegram.org/bots/features#privacy-mode) is disabled
- Копируем файл env/prod/.env-to-rename в .env и прописываем свои креды
- Разворачиваем приложение на хостинге через запуск env/prod/docker-compose.yml
- Пишем боту сообщение и через БД делаем себя суперюзером (users -> is_superadmin)
- От суперадмина добавляем бота в чат комьюнити
- Изменяем ограничение по количеству участников в группе через таблицу, если это необходимо (community -> capacity)
- Просим человека, который будет админом этого комьюнити написать боту в личку
- Делаем его админом комьюнити через таблицу community_admins

### Внутренние особенности сервиса
В сервисе есть 3 роли. Админ комьюнити, суперюзер и пользователь. Админ комьюнити может управлять своими комьюнити, суперадмин всеми, а пользователь может голосовать. 

В сервисе есть возможность с помощью процедурки "размножить" эвент через БД. Это позволяет админу комьюнити в которых ничего не меняется и не добавлять эвенты
каждый раз. Но при этом остается возможность удалить мероприятие через бота в его личке. Таким образом можно убрать эвент если он попадает на праздник или
переносится в случае форс мажора. Мы повторяем мероприятие N раз с id = 1 раз каждые 7 дней

```
do $$
begin
    for counter in 1..1 loop
        insert into community_bot_db.event (
            community_id,
            event_description,
            event_date,
            poll_date,
            poll_confirmation_date,
            notification_date
        )
        select
            community_id,
            event_description,
            event_date + ((counter * 7)::text||' days')::interval,
            poll_date + ((counter * 7)::text||' days')::interval,
            poll_confirmation_date + ((counter * 7)::text||' days')::interval,
            notification_date + ((counter * 7)::text||' days')::interval
        from community_bot_db.event where event_id = 1;
    end loop;
end; $$

```

Откат изменений.

```
DELETE FROM community_bot_db.event
WHERE event_id > 1 AND community_id = (SELECT community_id FROM community_bot_db.event WHERE event_id = 1)
```

### Команды бота для botfather
- replace - Отказываюсь от своей записи на мероприятие (приват)
- participants_list - Получить список учавствующих в мероприятии (админ)
- create_appointment - Создать мероприятие (админ, приват)
- fetch_events - Получить все активные события (админ, приват)
- fetch_events_short - Получить активные события за 2 недели (админ, приват)
- delete_event - Удалить событие (админ, приват)